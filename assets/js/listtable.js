$(function(){InitListTable()});function InitListTable(a){if(a==null){a=$(".listtable")}$(".b div",a).click(function(){listtableItemListAction(this);return false});$(".il input[type=checkbox]",a).click(function(){listtableToggleItemList(this)}).each(function(){listtableToggleItemList(this,1)})}function getListTable(a){if(a==null){return $(".listtable:first")}if($(a).hasClass("listtable")){return a}return $(a).parents(".listtable")}function listtableAddItem(e,f){if(e==null){var e=new Array()}var c=getListTable(f);var b=$(".item",c).length;var d=$(".item:first",c).clone();var a=false;listtableСlearItemData(d);c.append(d);listtableSetItemIndex(d.prev(),b-1);listtableSetItemIndex(d,b);InitListTable(d);if(e.list!=null){checkbox=$("input[name=islist]",d).attr("checked","checked");a=listtableToggleItemList(checkbox[0]);d.next().find(":input").val(e.list)}listtableHighLightItem(d,a)}function listtableToggleItemList(d,e){var c=$(d).parent("td").parent(".item");var a=listtableItemHasList(c);if(d.checked){if(a!=false){a.show()}else{var b=c.parent("tbody").children(".item").index(c);var a='<tr class="list'+(b%2?"":" odd")+'">';a+='<th>список:</th><td colspan="8">';a+=listtableGetItemList(b);a+="</td></tr>";a=$(a);c.after(a);useListValueAsItemTitle($("select",a)[0])}c.addClass("wlist");$(".ib :checkbox:hidden",c).show()}else{if(a!=false){a.hide()}c.removeClass("wlist");$(".ib :checkbox:hidden",c).hide()}if(e==null){listtableHighLightItem(c,a)}}var defaultSelectItems=null;function listtableGetItemList(a){if(defaultSelectItems==null){if(listItems==null){return}for(i=0;i<listItems.length;i++){defaultSelectItems+='<option value="'+listItems[i][0]+'" title="'+listItems[i][2]+'">'+listItems[i][1]+"</option>"}}return'<select name="item['+a+'][list_id]" onchange="useListValueAsItemTitle(this)">'+defaultSelectItems+"</select>"}function useListValueAsItemTitle(a){previtem=$(a).parents("tr").prev(".item");textfield=$("input[type=text]",previtem);if(textfield[0]!=null&&(textfield[0].value==""||textfield.data("autoSet"))){textfield.data("autoSet",true);textfield.keypress(function(){$(this).data("autoSet",false)});textfield[0].value=a.options[a.selectedIndex].text;$(".ib :checkbox",previtem).attr("checked",(a.options[a.selectedIndex].title!="0"?"checked":""))}}function listtableItemHasList(a){if(a.next().hasClass("list")){return a.next()}return false}function listtableItemListAction(g){var e=$(g).parent("td").parent(".item");var b=listtableItemHasList(e);var d=e.parent("tbody").children(".item").index(e);switch(g.className){case"delete":if(!confirm("Вы уверены?")){return false}e.parent("tbody").children(".item:gt("+d+")").each(function(){listtableSetItemIndex($(this),d++)});if(e.nextAll(".item:first").length==0){$(".down",e.prev()).addClass("nobut");if(e.prev(".item").prev(".item").length==0){$(".delete",e.prev()).addClass("nobut")}}e.remove();if(b!=false){b.remove()}return false;break;case"up":var c=e.prevAll(".item:first");e.insertBefore(c);if(b!=false){b.insertAfter(e)}listtableSetItemIndex(e,d-1,b);listtableSetItemIndex(c,d);break;case"down":var a=e.nextAll(".item:first");var f=listtableItemHasList(a);e.insertAfter(f!=false?f:a);if(b!=false){b.insertAfter(e)}listtableSetItemIndex(e,d+1,b);listtableSetItemIndex(a,d,f);break}listtableHighLightItem(e,b);return false}function listtableHighLightItem(b,a){b.parent("tbody").children(".h").removeClass("h");b.addClass("h");if(a!=false){a.addClass("h")}}function listtableSetItemIndex(d,c,b){if(c==null){c=d.parent("tbody").children(".item").index(d)}else{if(c==0){$(".up",d).addClass("nobut")}else{$(".up",d).removeClass("nobut")}}if(d.nextAll(".item:first").length==0){$(".down",d).addClass("nobut")}else{$(".down",d).removeClass("nobut")}if(c==0&&d.nextAll(".item:first").length==0){$(".delete",d).addClass("nobut")}else{$(".delete",d).removeClass("nobut")}if(b==null){b=listtableItemHasList(d)}if(c%2){d.removeClass("odd");if(b!=false){b.removeClass("odd")}}else{d.addClass("odd");if(b!=false){b.addClass("odd")}}var a=/([^\[]+)\[\d*\](.*)/;d.find(":input").each(function(){if(this.type=="radio"&&this.name=="default_item"){this.value=c;return}if($(this).data("name")==null){var e=a.exec($(this).attr("name"));if(e!=null){$(this).data("name",{prefix:e[1],suffix:e[2]})}else{return}}$(this).attr("name",$(this).attr("name").replace(a,$(this).data("name").prefix+"["+c+"]"+$(this).data("name").suffix))});if(b!=false){b.find(":input").each(function(){$(this).attr("name",$(this).attr("name").replace(a,"$1["+c+"]$2"))})}}function listtableСlearItemData(b,a){if(a==null){a=listtableItemHasList(b)}b.find(":input").each(function(){switch(this.type){case"checkbox":case"radio":$(this).attr("checked","");break;case"select":$(this).val(this.options[0].value);break;default:$(this).val("");break}});if(a!=false){a.find(":input").each(function(){switch(this.type){case"checkbox":case"radio":$(this).attr("checked","");break;case"select":$(this).val(this.options[0].value);break;default:$(this).val("");break}})}};