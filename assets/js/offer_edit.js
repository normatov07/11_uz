$(function () {    var MAX_IMAGES = 7;    var THEFORM = $('#edit_offer_form');    var PROPERTIESSET = false;    var current_region_id;    var category_warning = {};    function editInit() {        $('.preload').hide();        $('.main').show();        category = new Array();        /**         * Запоминаем выставленный список категорий         */        category_pre_set = false;        if ($('#category_id').prev('span').length) {            category_pre_set = true;            parent_category_id = ($('#category_id').prev('span').attr('id'));            console.log(parent_category_id)            $('span', $('#category_id').parent()).click(reSelectCategory);        } else {            parent_category_id = 0;            $('#category_id').val('');        }        category[parent_category_id] = new Array();        i = 0;        k = 0;        current_category_id = 0;        if (option = $('#category_id').attr('options')) {            while (i < option.length) {                if (option[i].value == '') {                    i++;                    continue;                }                category[parent_category_id][k] = {id: option[i].value, title: option[i].text};                if (option[i].selected) {                    var current_category_id = option[i].value;                    console.log(current_category_id);                    if ($('#district_id')[0]) category[parent_category_id][k].has_district = true;                    if ($('#subway_id')[0]) category[parent_category_id][k].has_subway = true;                }                i++;                k++;            }        }        if (!current_category_id) current_category_id = parent_category_id;        /**         * Запоминаем корневой список типов         */        type = new Array();        type[current_category_id] = new Array();        i = 0;        k = 0;        if (option = $('#type_id').attr('options')) {            while (i < option.length) {                if (option[i].value == '') {                    i++;                    continue;                }                var titleval = option[i].title.split('|');                has_price = 0;                autotitle = 0;                if (titleval[0] != null && titleval[0] != 0) {                    has_price = 1                }                ;                if (titleval[1] != null && titleval[1] != 0) {                    autotitle = 1                }                ;                type[current_category_id][k] = {                    id: option[i].value,                    title: option[i].text,                    has_price: has_price,                    autotitle: autotitle                };                if (option[i].selected && autotitle) {                    $('#title_block').hide();                    $('#title').attr('requred', '');                }                ;                i++;                k++;            }            ;        }        ;        /**         * Запоминаем список district и subway для данного региона         */        region = new Array();        current_region_id = $('#region_id').val();        if ($('#district_id')[0]) {            if (region[current_region_id] == null) region[current_region_id] = new Array();            region[current_region_id]['districts'] = new Array();            region[current_region_id]['district_title'] = $('#district_title').html();            region[current_region_id]['has_district'] = true;            i = 0;            k = 0;            if (option = $('#district_id').attr('options')) {                while (i < option.length) {                    if (option[i].value == '' || option[i].value < 0) {                        i++;                        continue;                    }                    region[current_region_id]['districts'][k] = {id: option[i].value, title: option[i].text};                    i++;                    k++;                }                ;            }            ;        }        ;        if ($('#subway_id')[0]) {            if (region[current_region_id] == null) region[current_region_id] = new Array();            region[current_region_id]['subways'] = new Array();            region[current_region_id]['has_subway'] = true;            i = 0;            k = 0;            if (option = $('#subway_id').attr('options')) {                while (i < option.length) {                    if (option[i].value == '' || option[i].value < 0) {                        i++;                        continue;                    }                    region[current_region_id]['subways'][k] = {id: option[i].value, title: option[i].text};                    i++;                    k++;                }                ;            }            ;        }        ;        if ($('.step').length) {            $('.step:eq(0)').click(function () {                $('#category_id').fadeOut('200').fadeIn('200').focus();            });        }        ;        /* --------- */        property = new Array();        propertyHTML = new Array();        $('#category_id').change(selectCategory);        $('#region_id').change(selectRegion);//		$('#description').keyup(function(){ symbolsLeft(this);}).blur(function(){gotoStep(1); symbolsLeft(this)}).blur();        $('input', THEFORM).change(function () {            gotoStep()        }).blur(function () {            gotoStep(1)        });        $('.file', THEFORM).change(function () {            imageAddField(this)        });        if (useAjax) {            THEFORM.ajaxForm(addFormOptions);        }        ;        if (category_pre_set) {            $('#type_id').change(typeChange).change();        }        ;        $('#has_not_user_yes').click(function () {            $('#quick_registration').show();            $('#offer_contacts').hide();        });        $('#has_not_user_no').click(function () {            $('#quick_registration').hide();            $('#offer_contacts').show();        });        $('#price_type').change(priceTypeChange);        modifyInputsWithOtherValue();        /**         * EDIT RELATED         */        $(':radio', '#images .list').click(imageSetMain);        $(':checkbox', '#images .list').click(imageReInit);    }    function addFormHandle(json) {        if (showErrors(json.errors)) {            refreshCaptcha();            $(':submit, :image', THEFORM).removeAttr('disabled');        } else {            if (json.data != null && json.data['save_and_continue'] != null) {                if (json.messages != null) {                    showMessage(json.messages);                }                $(':submit, :image', THEFORM).removeAttr('disabled');                clearFormToContinue();            } else if (json.redirect != null) {                $('#ajaxstatus').html('Пожалуйста подождите...').show();                location.href = json.redirect;            } else {                if (json.messages != null) {                    showMessage(json.messages);                }                $('#ajaxstatus').html('Пожалуйста подождите...').show();                if (offer_id = $(':input[name="id"]', THEFORM).val()) {                    setTimeout(function () {                        location.href = '/offer/' + offer_id + '/'                    }, 2000);                } else {                    setTimeout(function () {                        location.href = '/'                    }, 2000);                }            }        }    }    var requiredNotSet;    var addFormOptions = $.extend({}, ajaxOptions || {},        {            success: addFormHandle,            beforeSubmit: function (formArray, jqForm) {                if (formArray.length == 0 || !gotoStep(null, null, true)) {                    i = 0;                    while (requiredNotSet[i] != null) {                        requiredNotSet[i] = 'Не заполнено обязательное поле: "' + requiredNotSet[i] + '"';                        i++;                    }                    return !showErrors(requiredNotSet);                } else {                    formArray[formArray.length] = {name: 'is_ajax', value: 1};                    hideMessage();                    $(':submit, :image', THEFORM).attr('disabled', 'disabled');                }            }        });    function clearFormToContinue() {        $(':input', THEFORM).each(function () {            switch (this.name) {                case 'category_id':                case 'type_id':                case 'region_id':                case 'has_not_user':                    break;                default:                    switch (this.type) {                        case 'select-one':                            var i = 0;                            var defSel = 0;                            while (i < this.options.length) {                                if (this.options[i].defaultSelected) {                                    defSel = i;                                    break;                                }                                ;                                i++;                            }                            ;                            this.options[defSel].selected = 'selected';                            break;                        case 'submit':                        case 'button':                        case 'image':                            break;                        default:                            this.value = '';                            break;                    }                    break;            }        });        $('.del_image').click();        gotoStep();    }    /**     * IMAGES UPLOAD     */    function imagesAmount() {        currentimages = 0;        $(':checkbox', '#images .list').each(function (i) {            if (!this.checked) currentimages++;            else if (i == $(':radio', '#images').index($(':radio:checked'))) {                imageFindMain();            }        });        return $('.item', '#images').length + currentimages;    }    function imageAddField(fileField) {        if (imagesAmount() < MAX_IMAGES) {            if (fileField == null) fileField = $('.item:last :file', '#images');            par = $(fileField).parent();            if (t = par[0].outerHTML) par.after(t).children('label, .del_image').remove();            else par.after(par.clone()).children('label, .del_image').remove();            $(fileField).unbind('change');            par.next().children('.del_image').click(imageRemoveField);            if ($(':radio', par).length == 0) {                par.append('<a href="#" class="del_image">удалить</a><label><input type="radio" class="r" name="mainimage"></label>').next().children(':file').val('').change(function () {                    imageAddField(this)                });                $(':radio', par).click(imageSetMain);                $('.del_image', par).click(imageRemoveField);            }            imageReInit();        }    }    function imageRemoveField() {        var par = $(this).parent();        par.remove();        imageFindMain();        imageReInit();        return false;    }    function imageSetMain() {        $(':radio', '#images').next('span').hide();        i = $(':radio', '#images').index($(this));        if ($(':checkbox:eq(' + i + '):checked', '#images').length) {            imageFindMain();            return false;        } else {            $(this).after('<span>Основная</span>');        }        return true;    }    function imageFindMain() {        ind = $(':checkbox', '#images .list').index($(':checkbox:not(:checked)'));        if (ind != -1) $(':radio:eq(' + ind + ')', '#images').click();        else $('.item:first :radio', '#images').click();    }    function imageReInit() {        hideMessage();        if ($(':radio', '#images').index($(':radio:checked')) == -1) $(':radio:first', '#images').click();        countFields = 0;        countRadios = 0;        $(':radio', '#images').each(function (i) {            delCheckbox = $(':checkbox:eq(' + i + ')', '#images');            if (!delCheckbox.length || !delCheckbox.attr('checked')) {                this.value = countRadios++;            } else {                this.value = -1;            }        });        var imagesCollection = $('.item', '#images');        imagesCollection.each(function (i) {            $(':file', this).attr('name', 'image[' + i + ']');            if ($(':file', this).val() != '') countFields++;            if (imagesAmount() < 7 && imagesCollection.index(this) == (imagesCollection.length - 1)) {                $('.del_image:visible', this).hide();            } else {                $('.del_image:hidden', this).show();            }        });        if (imagesAmount() > MAX_IMAGES) {            if ($(':file:last', '#images').val() == '') {                $(':file:last', '#images').remove();            } else {                showErrors('ВНИМАНИЕ! Фотографий не может быть более ' + MAX_IMAGES + '. Лишние фотографии будут пропущены.');            }        } else {            if ($('.add_images:hidden', '#images').length) {                $('.add_images:hidden', '#images').show();            } else if ($(':file:last', '#images').val() != '') {                imageAddField();            }        }    }    /**     * CATEGORY SELECTOR     */    function selectCategory(lnk) {        if (PROPERTIESSET && !confirm('При смене раздела параметры объявления будут стёрты. Вы уверены?')) {            PROPERTIESSET = false;            return false;        }        ;        PROPERTIESSET = false;        if (lnk == null || $(lnk).attr('tagName') != 'SPAN') {            categorySelect = $('#category_id');            id = categorySelect.val();            obj = categorySelect;        } else {            obj = $(lnk);            if (obj.prev().length) id = obj.prev().attr('id');            else id = 0;            categorySelect = null;        }         if (id != null) {            toggle_warning(id);            $(obj).parent().children('.note').hide();            showLoad(obj);            if (subs = getSubCategories(id, lnk)) {                $(obj).parent().children('.note').show();                hideLoad(obj);                if (subs != 'none') {                    if (categorySelect != null) {                        text = categorySelect.attr('options')[categorySelect.attr('selectedIndex')].text;                        lnk = '<div class="form-group" id="' + id + '"><a href="/offer/add/" class="btn btn-outline-primary">' + text + '</a></div>';                        $(categorySelect).after(createCategorySelect(id)).replaceWith(lnk);                        $('#category_id').change(selectCategory).prev('span').click(reSelectCategory);                    } else {                        obj.replaceWith(createCategorySelect(id));                        $('#category_id').change(selectCategory);                    }                } else {                    current = $('#type_id').val();                    $('#type_id').replaceWith(createTypeSelect(type[id] != null ? id : 0, current));                    if (property[id] != null) {                        if (propertyHTML[id] == null) {                            propertyHTML[id] = '';                            i = 0;                            while (property[id][i] != null) {                                propertyHTML[id] += '<tr>';                                propertyHTML[id] += '<th';                                if (property[id][i].req == 1) propertyHTML[id] += ' class="req"';                                propertyHTML[id] += '>' + property[id][i].title + ':';                                if (property[id][i].req == 1) propertyHTML[id] += ' <i class="note">*</i>';                                propertyHTML[id] += '</th>';                                propertyHTML[id] += '<td>' + property[id][i].input + '</td></tr>';                                i++;                            }                        }                    } else {                        propertyHTML[id] = '';                    }                    $('tbody', '#properties').html(propertyHTML[id]);                    if (propertyHTML[id] == '') {                        $('#properties').hide();                    } else {                        $('#properties').show();                        $(':input', '#properties').change(function () {                            gotoStep()                        }).blur(function () {                            gotoStep(1)                        });                        modifyCheckboxes();                        modifyRadios();                        modifySelects();                        modifyInputsWithOtherValue();                    }                    $('#type_id').change(typeChange).change();                    $('#category_id').blur();                    $('#properties').focus();                    gotoStep();                    selectRegion();                    return false;                }            }        }        gotoStep(null, 1);        return false;    }    function currentCategory() {        categorySelect = $('#category_id');        index = categorySelect.attr('selectedIndex') - 1;        if (index > -1) {            if (categorySelect.prev().length) parent_id = categorySelect.prev().attr('id');            else parent_id = 0;            if (category[parent_id][index] == null) return;            return category[parent_id][index];        }        ;    }    function selectRegion() {        region_id = $('#region_id').val();        if (region_id) {            cat = currentCategory();            if (cat.has_district || cat.has_subway) {                districtObj = $('#district_id');                subwayObj = $('#subway_id');                if (current_region_id != region_id                    || (cat.has_district && !districtObj.length)                    || (cat.has_subway && !subwayObj.length)                ) {                    if (reg = getRegion(region_id, cat.has_district, cat.has_subway)) {                        if (cat.has_district && reg.has_district != null && reg.districts != null) {                            list = reg.districts;                            list[list.length] = {id: -1, title: 'любой'};                            list[list.length] = {id: -2, title: 'нет'};                            html = '<tr>';                            html += '<th';                            if (cat.has_district == 2) html += ' class="req"';                            html += '>';                            html += reg.district_title + ':';                            if (cat.has_district == 2) html += '  <i class="req">*</i>';                            html += '</th>';                            html += '<td>';                            html += form_Select('district_id', list, '', 'Выберите', cat.has_district == 2);                            html += '</tr>';                            if (districtObj.length) {                                districtObj.parents('tr').replaceWith(html);                            } else {                                $('tbody', '#properties').prepend(html);                            }                            ;                        } else {                            districtObj.parents('tr').remove();                        }                        ;                        if (cat.has_subway && reg.has_subway != null && reg.subways != null) {                            html = '<tr>';                            html += '<th>Станция метро:';                            if (cat.has_subway == 2) html += '  <i class="req">*</i>';                            html += '</th>';                            html += '<td>';                            html += form_Select('subway_id', reg.subways, '', 'Выберите', cat.has_subway == 2);                            html += '</tr>';                            if (subwayObj.length) {                                subwayObj.parents('tr').replaceWith(html);                            } else if ($('#district_id').length) {                                $('#district_id').parents('tr').after(html);                            } else {                                $('tbody', '#properties').prepend(html);                            }                            ;                        } else {                            subwayObj.parents('tr').remove();                        }                        ;                        return true;                    }                    ;                    return true;                }                ;            }            ;        }        ;        current_region_id = region_id;        $('#district_id').parents('tr').remove();        $('#subway_id').parents('tr').remove();    }    function getRegion(id, req_district, req_subway) {        if (id == null) return false;        if (region != null && region[id] != null            && (req_district == null || region[id].has_district != null)            && (req_subway == null || region[id].has_subway != null)        ) return region[id];        $('#district_id').replaceWith('<span id="district_id" class="loading">Загрузка списка</span>');        $('#subway_id').replaceWith('<span id="subway_id" class="loading">Загрузка списка</span>');        $.getJSON("/region/get/" + id, function (json) {            if (!showErrors(json.errors) && json.obj != null) {                region[id] = json.obj;                if (json.data != null && json.data.districts != null) {                    region[id].district_title = json.data.district_title;                    region[id].districts = json.data.districts;                }                if (json.data != null && json.data.subways != null) {                    region[id].subways = json.data.subways;                }                return selectRegion();            }        });    };    function modifyInputsWithOtherValue() {        $('.other_input').each(            function () {                var other_input = $(this);                if (this.value == '') other_input.hide();                prev = $(this).prev();                if (prev.attr('tagName') == 'LABEL') input = $(':input', prev);                else input = prev;                switch (input.attr('type')) {                    case 'select-one':                        input.change(function () {                            if (this.value == 'other') other_input.show();                            else other_input.hide();                        });                        break;                    case 'checkbox':                        input.click(function () {                            if (this.checked) other_input.show();                            else other_input.hide();                        });                        break;                }                ;            }        );    }    function reSelectCategory() {        id = $(this).prev().attr('id');        if (id == null) id = 0;        hide_warning(id);        $(this).nextAll().remove();        if (sel = createCategorySelect(id)) {            $(this).replaceWith(sel);            $('#category_id').change(selectCategory);            gotoStep();        } else {            selectCategory(this);        }        return false;    }    function createCategorySelect(id, current) {        if (typeof category[id] != 'object' || !category[id].length) return false;        listArray = category[id];        var title = 'Выберите подкатегорию';        return form_Select('category_id', listArray, current, title);    }    function createTypeSelect(id, current) {        var title;        if (typeof type[id] != 'object' || !type[id].length) return false;        listArray = type[id];        if (listArray.length > 1) title = 'Выберите тип';        else current = listArray[0].id;        return form_Select('type_id', listArray, current, title);    }    function typeChange() {        var selected = 0;        if (this.selectedIndex != 0) selected = this.selectedIndex - 1;        if ((typeof(type[$('#category_id').val()]) != 'undefined')            && (type[$('#category_id').val()][selected].has_price == 1)) {            $('#price_block').show();        } else {            $('#price_block').hide();        }        ;        if ((typeof(type[$('#category_id').val()]) != 'undefined')            && (type[$('#category_id').val()][selected].autotitle == null || type[$('#category_id').val()][selected].autotitle == 0)) {            $('#title_block').show();            $('input#title').addClass('req');        } else {            $('#title_block').hide();            $('input#title').removeClass('req');        }        ;        gotoStep();    }    function getSubCategories(id, lnk) {        if (id == null) return false;        if (category[id] != null) {            return category[id];        }        $.getJSON("/category/get/" + id, function (json) {            if (json.errors == null) {                category[id] = 'none';                if (json.data != null) {                    if (json.data.subs != null && json.data.subs.length) {                        category[id] = json.data.subs;                    }                    if (json.data.types != null) {                        type[id] = json.data.types;                    }                    if (json.data.properties != null) {                        property[id] = json.data.properties;                    }                    if (json.data.has_district != null || json.data.has_subway != null) {                        i = 0;                        while (category[parent_category_id][i] != null) {                            if (category[parent_category_id][i].id == id) {                                category[parent_category_id][i].has_district = (json.data.has_district != null);                                category[parent_category_id][i].has_subway = (json.data.has_subway != null);                                break;                            }                            i++;                        }                    }                    if (json.data.category_warning) {                        category_warning['n' + id] = json.data.category_warning;                    }                }                return selectCategory(lnk);            }        });    }    function toggle_warning(id) {        if ((typeof(category_warning['n' + id]) != 'undefined') && category_warning['n' + id]) {            if (category_warning['n' + id].warning_status) {                show_warning(id);            }            else {                hide_warning(id)            }        }        else {            hide_warning(id)        }    }    function show_warning(id) {        if ((typeof(category_warning['n' + id]) != 'undefined') && category_warning['n' + id]) {            if (category_warning['n' + id].warning_status) {                $('#category_warning').show();                $('#warning_category_limit').html(category_warning['n' + id].offers_limit);                $('#warning_category_name').html(category_warning['n' + id].category_name);                $('#formContent').hide();            }        }    }    function hide_warning(id) {        $('#category_warning').hide();        $('#formContent').show();    }    function moveSteps(t, skipmove) {        /*		if(skipmove === 1) return;         if(t == 0){         $('.readiness').css('position','relative');         return;         }         $('.readiness').css('position','absolute');         $("#steps").animate({top: t+'px'}, 1500 );         */        return false;    }    function gotoStep(skipmove, hide, submitkey) {        var step = 0;        var tp = 0;        if (hide == true) {            $('#steps').children('.step').removeClass('done');            $('#properties:visible').hide();            if (!submitkey) $('#formContent:visible', THEFORM).hide();            $('.offer_intro').show();            return moveSteps(tp, skipmove);        }        requiredNotSet = [];// category        if ($('#category_id').val() != '') {            $('#steps').children('.step').eq(step++).addClass('done');            if ($('#category_warning').is(':hidden')) {                $('#formContent').show();            }            $('.offer_intro').hide();            tp = 1;        } else {            $('#steps').children('.step:gt(' + (step++ - 1) + ')').removeClass('done');            requiredNotSet.push('Раздел');            return gotoStep(0, 1, submitkey);        }// type        if ($('#type_id').val() != '') {            $('#steps').children('.step').eq(step++).addClass('done');            tp = 50;        } else {            $('#steps').children('.step:gt(' + (step++ - 1) + ')').removeClass('done');            requiredNotSet.push('type_id');//				return moveSteps(tp, skipmove);        }//	properties        reqEmpty = false;        $(':input', '#properties').each(function () {            if ((this.type == 'checkbox' && !this.checked) || $(this).val() == null || $(this).val() == '') {                if ($(this).hasClass('req')) {                    reqEmpty = true;                    requiredNotSet.push($(this).attr('id'));                }            } else {                PROPERTIESSET = true;            }        });        if (!reqEmpty) {            $('#steps').children('.step').eq(step++).addClass('done');            if (property[$('#category_id').val()] != null) {                tp += 50 + property[$('#category_id').val()].length * 36;            }        } else {            $('#steps').children('.step:gt(' + (step++ - 1) + ')').removeClass('done');//				return moveSteps(tp, skipmove);        }//	title        if ($('input#title').val() != '' || $('input#title').hasClass('req') == false) {            $('#steps').children('.step').eq(step++).addClass('done');            tp += 70;        }        else {            $('#steps').children('.step:gt(' + (step++ - 1) + ')').removeClass('done');            requiredNotSet.push('title');//				return moveSteps(tp, skipmove);        }// price        /*			if($('input#price').val() != ''){         $('#steps').children('.step').eq(step++).addClass('done');         tp += 80;         }else{         $('#steps').children('.step:gt('+(step++ - 1)+')').removeClass('done');         return moveSteps(tp, skipmove);         } */// desc        if ($('#description').val() != '') {            $('#steps').children('.step').eq(step++).addClass('done');            /*				if($('#quick_registration')[0] != null){tp += 180}             else tp += 100; */        } else {            $('#steps').children('.step:gt(' + (step++ - 1) + ')').removeClass('done');            requiredNotSet.push('description');//				return moveSteps(tp, skipmove);        }//	registration        if ($('#quick_registration').length) {            reqEmpty = false;            $(':input.req', '#quick_registration').each(function () {                if ((this.type == 'checkbox' && !this.checked) || $(this).val() == null || $(this).val() == '') {                    reqEmpty = true;                    requiredNotSet.push($(this).attr('id'));                }            });            if ($('#email', '#quick_registration').val() == '' && $('#phone', '#quick_registration:visible').val() == '') {                reqEmpty = true;                requiredNotSet.push('email" или "<a href="#" onclick="$(\'#phone\').focus()">Телефон</a>');            }            if (!reqEmpty) $('#steps').children('.step').eq(step++).addClass('done');            else {                $('#steps').children('.step:gt(' + (step++ - 1) + ')').removeClass('done');//					return moveSteps(tp, skipmove);            }        }// captcha        if ($('#captcha_code').val() != '') {            $('#steps').children('.step').eq(step++).addClass('done');        } else {            $('#steps').children('.step:gt(' + (step++ - 1) + ')').removeClass('done');            requiredNotSet.push('captcha_code');//				return moveSteps(tp);        }        if ($('#category_warning').is(':visible')) {            $('#steps').children('.step:gt(0)').removeClass('done');        }        if (requiredNotSet.length) return moveSteps(tp, skipmove);        return true;    }    function priceTypeChange() {        switch (this.value) {            case 'negotiated':                $('.price_from, .price_to, .price, .currency', '#price_block').hide();                break;            case 'fixed':                $('.price_from, .price_to', '#price_block').hide();                $('.price, .currency', '#price_block').removeClass('dn').show();                break;            case 'from-to':                $('.price, .price_from, .price_to, .currency', '#price_block').removeClass('dn').show();                break;        }    }    editInit();});