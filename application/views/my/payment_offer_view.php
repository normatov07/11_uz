<div class="main" id="main"><form name="payment" action="/my/payment/offer/" method="post" id="payment"><?php echo @$form_messages?><div id="content" class="editlist objList payment<?php if(!request::is_ajax()) echo ' dn'?>"><h4>Выберите тип необходимой услуги и способ оплаты:</h4><div class="bcorns bluetable"><i class="ct"><i></i><b></b></i>	<table>		<col width="120" />		<col width="220" />		<tbody>			<tr>				<th>Тип услуги:</th>				<td><select name="service_id"><?php	foreach( Lib::config('payment.service') as $id => $val):			if($id == 'bonus') continue; ?>						<option<?php if(!empty($val['unit'])) echo ' id="'.$id.'"';?> value="<?=$id?>"<?php if(@$service_id == $id) echo ' selected="selected"'?>><?=$val['title']?></option><?php	endforeach;?>					</select></td>				<td rowspan="3" class="note"><?php if(!empty($service_id) and $desc =  Lib::config('payment.service', $service_id, 'description')) echo '<h2>Справка</h2><p>'. $desc . '</p>';?></td>			</tr><?php	$unitslist = array();				if(empty($count)) $count = $tariffs[$method_id]->price;				$amount = Lib::config('payment.service', $service_id, 'amount');		$units = Lib::config('payment.unit', Lib::config('payment.service', $service_id, 'unit'));		$i = 1;//		while($i <= Lib::config('payment.max_amount_count'))://			$unitslist[$i] = format::declension_numerals($i*$amount, $units);//			$i++;//		endwhile;				$max_amount = Lib::config('payment.max_amount_count');		$disable_action = false; 		$dd_params = NULL;		if (($bonus_amount < $tariffs[$method_id]->price) && (!$this->isModerator())) 		{			$disable_action = true;			$dd_params = array('disabled' => 'disabled');		}//		if (!$this->isModerator())//		{//			$max_amount = min($max_amount, intVal($bonus_amount/$tariffs[$method_id]->price));//		}		while($i <= $max_amount):			$unitslist[$i*$amount] = format::declension_numerals($i*$amount, $units);			$i++;		endwhile;				if(Lib::config('payment.service', $service_id, 'amount')): ?>				<tr>				<th>Оказание услуги:</th>				<td>				<?=form::dropdown(array('name'=>'count', 'id' => 'count'), $unitslist, @$count)?>				</td>			</tr><?php	endif;?>						<tr>				<th>Способ оплаты:</th>				<td><ul class="method"><?php	$i = 0;		$methods = array();		foreach(Lib::config('payment.method') as $id => $val):			if(!empty($tariffs[$id])):?>					<li><label for="m_<?=$id?>"><input type="radio" name="method_id" class="<?php						$methods[$id]->price = isset($tariffs[$id]->amount)?$tariffs[$id]->price/$tariffs[$id]->amount:$tariffs[$id]->price;						$methods[$id]->currency_id = $val['currency'];						$methods[$id]->discount = $val['discount_enabled'];						$methods[$id]->currency = Lib::config('payment.currency', $val['currency']);																		switch($val['currency']):							case 'bonus':								$methods[$id]->comment = 'У Вас на счету <b>'.format::declension_numerals((int) $this->user->account->bonuses, Lib::config('payment.currency','bonus')).'</b>.<br><a href="/reklama/" class="g">Купить бонусы →</a>';							break;						endswitch;												?>" value="<?=$id?>" id="m_<?=$id?>"<?php										$price =  $count * $objList->count();					$price_html = format::money($price, $val['currency']);										if(!empty($val['convert'])):											$exchange = ORM::factory('exchange')->getCurrent();											$methods[$id]->exchange_rate = $exchange->{$val['currency']};						$methods[$id]->exchange_currency = Lib::config('payment.currency',Lib::config('payment.main_currency'),2);						$methods[$id]->comment = '<b>1 '.Lib::config('payment.currency',$val['currency'],0).'</b> = ' 							. $exchange->{$val['currency']} . ' ' . Lib::config('payment.currency',Lib::config('payment.main_currency'),0)//							. format::money($exchange->{$val['currency']}, Lib::config('payment.main_currency'))														. ' <span>(по курсу Центробанка Республики Узбекистан на '							. date::getLocalizedDate($exchange->added) .')</span>'; 					endif;											if((!isset($method_id) and $i == 0) or $id == @$method_id):											echo ' checked="checked"';						$current_comment = @$methods[$id]->comment;												if($this->user->discount > 0 and !empty($val['discount_enabled'])):														$discount = $price*$this->user->discount/100;										$discounted_price = $price - $discount;							$discounted_price_html = format::money($discounted_price, $val['currency']);													else:							if(isset($discount)) unset($discount);							endif;												if(!empty($val['convert'])):							$current_total = format::money($price * $methods[$id]->exchange_rate, Lib::config('payment.main_currency'));							if($this->user->discount > 0):								if(!empty($discount)):									$discount = format::money($discount * $methods[$id]->exchange_rate, Lib::config('payment.main_currency'));;									$discounted_total = format::money($discounted_price * $methods[$id]->exchange_rate, Lib::config('payment.main_currency'));								else:									$discounted_total = $current_total;								endif;							endif;						else:							$current_total = $price_html;							if($this->user->discount > 0):								if(!empty($discount)):									$discounted_total = $discounted_price_html;								else:									$discounted_total = $current_total;								endif;															endif;						endif;					endif;					?> /> <?=$val['title']?></label> <span>(<?=$price_html?>)</span></li><?php				if(!empty($val['in_descriptions'])):						$in_descriptions[] = $id;					endif;				$i++;			endif;		endforeach;?></ul>				</td>			</tr>		</tbody>			<tfoot>			<tr>				<td><input type="submit" value="Оплатить" name="proceed" class="submit" /></td>				<td><?php			if($this->user->discount > 0):?>				<div<?php if(empty($discount)) echo ' class="dn"'?>>Стоимость без скидки: <span id="raw_price"><?=@$current_total?></span></div>				<div class="discount<?php if(empty($discount)) echo ' dn'?>">Ваша скидка (<span id="discount"><?=@$this->user->discount?></span>%): -<span id="discount_price"><?=@$discount?></span></div>				<div class="total">Общая стоимость услуг: <div id="total_price"><?=@$discounted_total?></div></div><?php			else:?>							Общая стоимость услуг: <div id="total_price"><?=$current_total?></div><?php			endif?>				</td>				<td class="comment" id="comment"><?=$current_comment?></td>			</tr>		</tfoot>	</table>	<i class="cb"><i></i><b></b></i></div><?php	if(!empty($objList)):?>	<h4>Выбранные объявления (<?=@$objList->count()?>):</h4><?php		$categories = ORM::factory('category')->in('id',$objList->getValues('category_id'))->find_all()->as_id_array();				$types = ORM::factory('type')->find_all()->select_list(NULL, 'intention_title');			$regions = ORM::factory('region')->find_all()->select_list();					$offerIDs = array_keys($objList->select_list());						if(count($offerIDs)) $pictures = ORM::factory('picture')->find_all_for('offer', $offerIDs);				foreach($objList as $offer): ?>			<input type="hidden" name="id[]" value="<?=$offer->id?>" />			<div class="ofr <?php 				if($offer->is_premium):					echo ' premium'; 				elseif($offer->is_marked):					echo ' or';						endif;				?>"><i class="ct"><i></i><b></b></i>				<table>					<tr>						<td class="p"><?=$offer->price_html_list?><br/><?php			if(isset($pictures[$offer->id])):?>							<a href="<?=$offer->url?>"><?php echo $pictures[$offer->id]->f('thumb','html')?></a><?php			endif?></td>						<td class="d">							<h5><?=$types[$offer->type_id]?></h5>							<h3><a href="<?=$offer->url?>"><?=$offer->title?></a></h3>							<p><?=$offer->short_description?></p>						</td>						<td class="i">														<div class="c"><a href="<?=$categories[$offer->category_id]->url?>"><?=$categories[$offer->category_id]->title?></a></div>							<div class="c"><?=$regions[$offer->region_id]?></div>						</td>						<td class="m"><?=$offer->act_icons?></td>					</tr>				</table>				<i class="cb"><i></i><b></b></i>			</div><?php		endforeach;?><?php	endif;?></div></form><?php if(!request::is_ajax()):?><script type="text/javascript">	function hid(id, hide){return document.getElementById(id).style.display = (hide?'none':'block');};	hid('content');</script> 	<noscript><div class="mess bcorns error vis"><i class="ct"><i></i><b></b></i>	<h3>Внимание ошибка:</h3>	<ul>		<li>Для осуществления платежей необходим браузер с включённой поддержкой JavaScript.</li>	</ul><i class="cb"><i></i><b></b></i></div></noscript><?php endif;?><script type="text/javascript">	var methods = <?=json_encode($methods)?>;	</script><?php if(!empty($in_descriptions)):?><div class="payment_systems">	<h2>Принимаем к оплате:</h2><?php	foreach($in_descriptions as $id):			$method = Lib::config('payment.method', $id);?>	<div class="ps"><?php		if(!empty($method['logo'])):?>		<a href="<?=$method['url']?>"><img src="<?=$method['logo']?>" alt="<?=$method['title']?>" border="0"/></a><?php		endif?>		<?php		if(!empty($method['full_description'])):?>		<p><?=$method['full_description']?></p><?php		endif?>	</div><?php	endforeach;?></div><?php endif;?></div>