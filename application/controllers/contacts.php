<?php defined('SYSPATH') or die('No direct script access.');class Contacts_Controller extends Controller {	public function __construct()	{		parent::__construct();		$this->view = new View('contacts_view');		$this->title = 'Обратная связь';		$this->addJs('contacts.js');	}		public function index($mode = NULL)	{		if($mode == 'success') $this->messages->add('Спасибо! Ваше сообщение отправлено.');				if(!empty($_POST)):					$_POST = new Validation($_POST);						$_POST->pre_filter('trim',true)					  ->add_rules('title','required','length[1,255]')					  ->add_rules('message','required','length[1,1000]')			;			if(!$this->isLoggedIn() or $this->isNotActivated()):				$_POST->add_rules('name','required','length[3,64]')					->pre_filter('strtolower', 'email')					->add_rules('email','required',array('valid','email'))					->add_callbacks('captcha_code', array($this, 'check_captcha'))				;			else:				$_POST->name = $this->user->contact_name;				$_POST->email = $this->user->email;			endif;				if($_POST->validate()):				$message_data = array(					'email' => Lib::config('app.email_contact_address'),					'title' => $_POST->title,					'message' => $_POST->message,					'sender' => array($_POST->email, $_POST->name),					'ip' => $_SERVER['REMOTE_ADDR'],					'browser' => Kohana::user_agent(),					'js' => @$_REQUEST['no_js']?'отключен':'включен',					'time' => date('Y-m-d H:i:s'),				);				$message_tpl = 'email/quickcontact_view';				$subject = 'Контактная форма: ' . $_POST->title;				Lib::sendEmail($subject, $message_tpl, $message_data);				$this->redirect = '/contacts/success/';				return; 							else: // is valid				$this->errors->add($_POST->list_errors());				$this->obj = $_POST;			endif;				endif;		}		public function success(){		$this->message[] = 'Спасибо! Ваше сообщение отправлено.';	}}